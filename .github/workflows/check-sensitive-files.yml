name: Check Sensitive Files

on:
  workflow_call:
    inputs:
      skip-label:
        required: false
        type: string
        default: ignore-sensitive-files-pr

jobs:
  check-sensitive-files:
    if: ${{ github.actor != 'dependabot[bot]' }}
    name: Checks if sensitive files have been changed without authorization
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR labels
        id: check-labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Skip if not running in a PR
          if [ -z "${{ github.event.pull_request.number }}" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LABELS="$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels \
            --jq '.[].name' | tr '\n' ' ')"

          if echo "$LABELS" | grep -qw "${{ inputs.skip-label }}"; then
            echo "::notice::Skipping sensitive files check due to '${{ inputs.skip-label }}' label."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check-labels.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Detect sensitive file changes
        if: steps.check-labels.outputs.skip != 'true'
        id: sensitive-check
        run: |
          # Skip if not a PR
          if [ -z "${{ github.event.pull_request.base.sha }}" ]; then
            exit 0
          fi

          HEAD_SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          BASE_SHA=$(git merge-base "${{ github.event.pull_request.base.sha }}" "$HEAD_SHA")

          CHANGED_FILES="$(git diff --name-only --diff-filter=ACMRD "$BASE_SHA" "$HEAD_SHA" | tr '\n' ' ')"

          if [ -n "$CHANGED_FILES" ]; then
            if ! python3 .github/workflows/scripts/sensitive_file_check.py --config .github/workflows/config/sensitive_files.txt --files $CHANGED_FILES; then
              echo ""
              echo "To override, add the '${{ inputs.skip-label }}' label to this PR."
              exit 1
            fi
          fi
